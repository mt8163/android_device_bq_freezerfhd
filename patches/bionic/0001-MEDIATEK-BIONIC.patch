---
 libc/Android.bp           | 1 +
 libc/Android.mk           | 2 ++
 libc/bionic/ndk_cruft.cpp | 9 ++++++++-
 libc/libc.arm.map         | 1 +
 libc/libc.map.txt         | 1 +
 libc/libc.mips.map        | 1 +
 libc/libc.x86.map         | 1 +
 linker/Android.bp         | 3 ++-
 8 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/libc/Android.bp b/libc/Android.bp
index c339b0451..cd3fec90c 100644
--- a/libc/Android.bp
+++ b/libc/Android.bp
@@ -42,6 +42,7 @@ libc_common_flags = [
     "-Wunused",
     "-Wno-deprecated-declarations",
     "-Wframe-larger-than=2048",
+    "-fno-stack-protector",
 
     // Try to catch typical 32-bit assumptions that break with 64-bit pointers.
     "-Werror=pointer-to-int-cast",
diff --git a/libc/Android.mk b/libc/Android.mk
index 888404cf7..7c14eb969 100644
--- a/libc/Android.mk
+++ b/libc/Android.mk
@@ -1,4 +1,6 @@
 LOCAL_PATH := $(call my-dir)
 
+# Define some common cfla
+
 include $(call all-makefiles-under,$(LOCAL_PATH))
 
diff --git a/libc/bionic/ndk_cruft.cpp b/libc/bionic/ndk_cruft.cpp
index dbacf18f0..33181faaa 100644
--- a/libc/bionic/ndk_cruft.cpp
+++ b/libc/bionic/ndk_cruft.cpp
@@ -345,10 +345,17 @@ size_t dlmalloc_usable_size(void* ptr) {
 }
 
 // In L we added a public pthread_gettid_np, but some apps were using the private API.
-pid_t __pthread_gettid(pthread_t t) {
+pid_t __pthread_gettid_libc(pthread_t t) {
   return pthread_gettid_np(t);
 }
 
+pid_t __pthread_gettid_libc_private(pthread_t t) {
+  return pthread_gettid_np(t);
+}
+
+__asm__(".symver __pthread_gettid_libc,__pthread_gettid@LIBC");
+__asm__(".symver __pthread_gettid_libc_private,__pthread_gettid@@LIBC_PRIVATE");
+
 // Older versions of apportable used dlmalloc directly instead of malloc,
 // so export this compatibility shim that simply calls malloc.
 void* dlmalloc(size_t size) {
diff --git a/libc/libc.arm.map b/libc/libc.arm.map
index a4212dda7..6b441332b 100644
--- a/libc/libc.arm.map
+++ b/libc/libc.arm.map
@@ -121,6 +121,7 @@ LIBC {
     __pselect6; # arm x86 mips introduced=21
     __pthread_cleanup_pop;
     __pthread_cleanup_push;
+    __pthread_gettid; # arm x86 mips nobrillo
     __ptrace; # arm x86 mips
     __putlong;
     __putshort;
diff --git a/libc/libc.map.txt b/libc/libc.map.txt
index c271a57e4..ce2a0bf3c 100644
--- a/libc/libc.map.txt
+++ b/libc/libc.map.txt
@@ -121,6 +121,7 @@ LIBC {
     __pselect6; # arm x86 mips introduced=21
     __pthread_cleanup_pop;
     __pthread_cleanup_push;
+    __pthread_gettid; # arm x86 mips nobrillo
     __ptrace; # arm x86 mips
     __putlong;
     __putshort;
diff --git a/libc/libc.mips.map b/libc/libc.mips.map
index 214c7f506..382b2a590 100644
--- a/libc/libc.mips.map
+++ b/libc/libc.mips.map
@@ -118,6 +118,7 @@ LIBC {
     __pselect6; # arm x86 mips introduced=21
     __pthread_cleanup_pop;
     __pthread_cleanup_push;
+    __pthread_gettid; # arm x86 mips nobrillo
     __ptrace; # arm x86 mips
     __putlong;
     __putshort;
diff --git a/libc/libc.x86.map b/libc/libc.x86.map
index 145b64ebf..dc4ce9c5b 100644
--- a/libc/libc.x86.map
+++ b/libc/libc.x86.map
@@ -118,6 +118,7 @@ LIBC {
     __pselect6; # arm x86 mips introduced=21
     __pthread_cleanup_pop;
     __pthread_cleanup_push;
+    __pthread_gettid; # arm x86 mips nobrillo
     __ptrace; # arm x86 mips
     __putlong;
     __putshort;
diff --git a/linker/Android.bp b/linker/Android.bp
index 1fcb4f723..f4dbd2de6 100644
--- a/linker/Android.bp
+++ b/linker/Android.bp
@@ -115,7 +115,8 @@ cc_binary {
         },
     },
 
-    cppflags: ["-Wold-style-cast"],
+    cppflags: ["-Wold-style-cast",
+               "-DUSE_LD_CONFIG_FILE"],
 
     // we are going to link libc++_static manually because
     // when stl is not set to "none" build system adds libdl
-- 
2.17.1

